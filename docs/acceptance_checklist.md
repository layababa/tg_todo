# ✅ 用户验收清单 (User Acceptance Checklist) _v4.0_

本文档严格按照 **“功能场景 -> 正常流程 + 异常/边界流程”** 的结构编写。
验收时请对每个功能的**正反两面**进行测试，确保系统不仅能跑通，还能优雅处理错误。

---

## 0. ⚪ 阶段零：首次接触与账号初始化 (Onboarding)

### 0.1 首次打开 Mini App（Story 0）

---

## 1. 🟢 阶段一：Bot 基础交互 (Bot Interaction)

### 1.1 `/start` 指令

- [ ] **正常流程**:
  - [ ] 私聊发送 `/start` -> Bot 回复欢迎卡片且带 "打开 Mini App" 按钮。
  - [ ] 携带参数 `/start settings` -> Bot 回复并带直达参数的按钮。
- [ ] **异常/边界**:
  - [ ] **重复启动**: 用户多次发送 `/start` -> Bot 每次都能正常回复，不报错，不重复创建用户数据。
  - [ ] **无效参数**: 发送 `/start invalid_param_123` -> Bot 忽略错误参数，回复默认欢迎语（兜底处理）。
  - [ ] **被拉黑后**: 用户 Block Bot 后解封，再次 `/start` -> Bot 识别用户回归，状态更新为 Active。

### 1.2 `/help` 指令

- [ ] **正常流程**:
  - [ ] 发送 `/help` -> Bot 回复操作指引、文档链接。
- [ ] **异常/边界**:
  - [ ] **群聊刷屏**: 在群里连续发送 5 次 `/help` -> Bot 应有防刷机制（或 TG 自身限流），不应导致服务崩溃。

### 1.3 菜单与快捷键 (`/menu`, `/close`)

- [ ] **正常流程**:
  - [ ] 发送 `/menu` -> 唤起底部快捷键盘 (Reply Keyboard)。
  - [ ] 发送 `/close` -> 移除快捷键盘。
- [ ] **异常/边界**:
  - [ ] **重复移除**: 键盘已移除的情况下再次发送 `/close` -> Bot 提示 "键盘已隐藏" 或静默成功，不报错。

### 1.4 Bot 入群欢迎与绑定引导（Story G1）

- [ ] **正常流程**:
  - [ ] 将 Bot 邀请进一个全新的群聊 -> Bot 自动发送欢迎消息 + 「为本群绑定 Notion 数据库」按钮。
  - [ ] 群管理员点击按钮 -> 能直接跳转到 Mini App 的群组设置页面。
  - [ ] 欢迎消息固定在群内最近几条消息之内（可选 pin），确保新成员看得到。
- [ ] **异常/边界**:
  - [ ] **非管理员点击**: 普通群员点击绑定按钮 -> App 提示 "仅管理员可操作" 并拒绝访问。
  - [ ] **重复邀请**: Bot 被移除后再次被拉入 -> 只发送一次欢迎消息，不重复创建群组映射，状态重置为可绑定。

### 1.5 新成员加入已配置群聊（Story G2）

- [ ] **正常流程**:
  - [ ] 在已绑定数据库的群里新增成员 -> Bot 私聊/群内发送欢迎提示，附带「打开 Mini App」按钮。
  - [ ] 新成员点开 Mini App -> 默认展示该群任务列表，并可查看历史任务上下文。
- [ ] **异常/边界**:
  - [ ] **未绑定 Notion**: 新成员尚未绑定 Notion 账号 -> App 顶部展示「绑定 Notion 以接受指派」提示，但仍可浏览任务。
  - [ ] **权限校验**: 新成员被移出群聊 -> 再次打开 Mini App 的群视图时受到权限限制，无法访问离开群的任务列表。

---

## 2. 🟡 阶段二：任务创建 (Task Creation)

### 2.1 指令创建 (`/todo`)

- [ ] **正常流程**:
  - [ ] 群内发送 `/todo fix bug` -> Bot 回复 "✅ 任务已创建" 并附带详情按钮。
  - [ ] **默认自我指派 (Story S1)**: 不 @ 其他人时，任务默认指派给操作者本人，在「我被指派」列表中可见。
- [ ] **异常/边界**:
  - [ ] **空内容**: 发送 `/todo` (后面没字) -> Bot 提示 "请在指令后输入任务标题"。
  - [ ] **超长文本**: 发送 `/todo [2000字]` -> 任务成功创建，Bot 回复截断的标题，不报错。
  - [ ] **特殊字符**: 标题包含 Emoji / HTML 标签 / SQL 注入字符 -> 正常保存，原样显示。

### 2.2 引用创建 (Reply to Message)

- [ ] **正常流程**:
  - [ ] 引用一条文本消息回复 `/todo` -> 新任务自动截取原消息作为 Context。
- [ ] **异常/边界**:
  - [ ] **引用非文本**: 引用 **图片/视频/文件** -> 任务创建成功，Context 显示 `[Image]` / `[File]` 占位符。
  - [ ] **引用 Bot 消息**: 引用 Bot 自己的回复 -> 任务创建成功（Bot 视为普通用户）。
  - [ ] **跨 Topic 引用**: 在 Topic A 引用 Topic B 的消息 -> Bot 在 Topic A 回复确认，不乱串。

### 2.3 转发创建 (Forward to Bot)

- [ ] **正常流程**:
  - [ ] 转发文字/图片给 Bot (私聊) -> Bot 回复 "已保存到个人收件箱"。
- [ ] **异常/边界**:
  - [ ] **不支持的类型**: 转发 **语音/位置/名片** -> Bot 回复 "不支持该消息类型" 或存为 `[Unsupported]` 标题的任务。
  - [ ] **未绑定个人库**: 用户未设置默认库 -> Bot 存入本地 Pending 状态，提示 "建议绑定 Notion"。

### 2.4 多人指派与未激活用户提醒（Story S2）

- [ ] **正常流程**:
  - [ ] 在群聊中 Reply 消息并同时 @ 多个成员 + Bot -> 自动创建多人指派任务，Mini App 列表中每位成员均能看到被指派的任务。
  - [ ] 每位被指派成员收到私聊通知以及 Deep Link，点击后直达任务详情。
- [ ] **异常/边界**:
  - [ ] **未 Start Bot**: 被指派成员未曾启动 Bot -> 群内应收到「@User 无法发送通知，请先私聊我点击 Start」的提示。
  - [ ] **重复指派**: 已经被指派的成员再次被添加 -> Bot 识别重复并提示「用户已在指派列表」而不会创建重复记录。

### 2.5 上下文快照（10 条历史消息抓取）

- [ ] **正常流程**:
  - [ ] 通过引用消息创建任务时 -> 系统自动抓取该消息之前的 10 条群聊记录作为上下文快照。
  - [ ] 在 Mini App 任务详情页可以查看上下文快照区域，展示抓取的历史消息列表。
  - [ ] 上下文快照同步写入 Notion 页面，方便在 Notion 中回溯讨论背景。
- [ ] **异常/边界**:
  - [ ] **历史消息不足 10 条**: 群聊消息少于 10 条 -> 仅抓取可用的消息数量，不报错。
  - [ ] **包含图片/文件消息**: 上下文中有图片或文件 -> 在快照中显示 `[Image]` / `[File]` 占位符，不存储实际文件。
  - [ ] **消息已被删除**: 上下文中的消息后续被删除 -> 已存储的快照保持不变，不受影响。
  - [ ] **Bot 消息过滤**: 上下文消息来自 Bot 自己 -> 正常包含在快照中，不做特殊过滤。

---

## 3. 🔵 阶段三：Mini App 核心体验 (App UX)

### 3.1 启动与登录

- [ ] **正常流程**:
  - [ ] 点击按钮打开 App -> 0.5s 内进入首页（无感登录）。
- [ ] **异常/边界**:
  - [ ] **断网加载**: 飞行模式下打开 -> 显示 "网络错误，点击重试" 插画（非白屏）。
  - [ ] **Token 过期**: 本地存储的 Token 失效 -> App 自动静默刷新 (Silent Refresh) 或弹窗引导重新登录。
  - [ ] **非法打开**: 在浏览器直接访问 App URL (无 TG 环境) -> 显示 "请在 Telegram 中打开" 提示。

### 3.2 任务列表 (List View)

- [ ] **正常流程**:
  - [ ] 正常加载并显示任务；下拉刷新有效；触底加载更多。
  - [ ] **视图切换**: 点击「我被指派」Tab -> 仅显示 Assignee 包含我的任务。
  - [ ] **视图切换**: 点击「我创建」Tab -> 仅显示 Created By 我的任务。
  - [ ] **视图切换**: 点击「全部」Tab -> 显示群内所有任务。
  - [ ] **多群聚合 (FAQ Q6)**: 用户同时在多个群有任务 -> 首页聚合展示所有来源，按时间排序。
- [ ] **异常/边界**:
  - [ ] **空数据**: 没有任何任务 -> 显示 "暂无任务" 空状态页。
  - [ ] **数据过载**: 这里的 Database 有 1000+ 条任务 -> 分页加载流畅，不卡死。
  - [ ] **脏数据**: 某任务缺少 Title 或 Status 字段 -> 列表项显示 "Unknown Title" 或默认状态，不 Crash。

### 3.2.1 搜索功能 (FAQ Q21)

- [ ] **正常流程**:
  - [ ] 首页顶部提供搜索框 -> 输入关键词后触发服务端搜索，不全量加载到前端。
  - [ ] 搜索结果按相关度排序，支持分页。
- [ ] **异常/边界**:
  - [ ] **无结果**: 搜索关键词无匹配 -> 显示 "未找到相关任务" 空状态。
  - [ ] **特殊字符**: 搜索包含 SQL 注入或特殊符号 -> 正常处理，不报错。

### 3.3 任务详情 (Detail View)

- [ ] **正常流程**:
  - [ ] 展示完整信息；点击 "Context" 跳转回聊天；点击 "Notion" 打开外链。
- [ ] **异常/边界**:
  - [ ] **任务已删除**: 停留在详情页时，别处删除了该任务 -> 点击保存时提示 "任务不存在" 并退回列表。
  - [ ] **长文本溢出**: 描述内容极长 -> 详情页支持滚动，布局不崩坏。
  - [ ] **原始消息已删**: 点击 "Jump to Chat" 但原消息已被删除 -> Telegram 提示 "消息不存在" (App 端无能为力，但不能 Crash)。

### 3.4 任务状态更新与权限（Story S3）

- [ ] **正常流程**:
  - [ ] 任务创建人、被指派人、群管理员均可在详情页中标记「完成」或「重新打开」，操作结果实时写回列表。
  - [ ] 状态变更后任务自动移动至对应分组（如「已完成」/「待跟进」），并在动态区域记录「由谁修改」。
- [ ] **异常/边界**:
  - [ ] **无权限用户**: 与任务无关的普通群员尝试变更状态 -> App 弹出「无权限」提示，不修改任务。
  - [ ] **并发冲突**: 两人几乎同时修改同一任务 -> 采用 Last Write Wins；后提交的一方看到「已被更新，已刷新最新状态」提示。

### 3.5 数据库筛选器（Story S8）

- [ ] **正常流程**:
  - [ ] 在首页顶部打开「来源/项目」筛选器 -> 选择某个 Notion Database 后，只显示对应任务。
  - [ ] 点击「全部」或清除筛选 -> 列表恢复聚合视图。
- [ ] **异常/边界**:
  - [ ] **空结果**: 选定的 Database 当前无任务 -> 显示「该项目暂无任务」的空状态，而非保留上一份缓存结果。
  - [ ] **切换中断**: 切换筛选时网络断开 -> App 显示重试按钮，恢复网络后可继续拉取。

### 3.6 离线任务标记（Story O1）

- [ ] **正常流程**:
  - [ ] 在离线模式下创建的任务在列表与详情均展示「Pending Notion Sync」标签或 Notion 图标斜杠。
  - [ ] 用户仍可编辑标题/描述/截止时间，编辑结果保留在本地/服务端缓存中。
- [ ] **异常/边界**:
  - [ ] **误触发同步**: 离线任务被误判为已同步 -> 在任务行展示错误标记时可通过刷新重新核验状态。
  - [ ] **批量删除**: 用户在未完成同步前删除任务 -> 系统正常软删除本地记录，稍后不会再尝试推送到 Notion。

### 3.7 溯源：从工单跳转回群聊上下文（Story S6）

- [ ] **正常流程**:
  - [ ] 在任务详情页点击「💬 跳转至对话」图标（Jump to Message）-> Mini App 关闭，Telegram 自动定位到该任务创建时引用的那条原始消息。
  - [ ] 在任务列表卡片上点击「跳转」快捷按钮 -> 同样能直接跳转到原始消息位置。
  - [ ] Topic 群组中创建的任务 -> 跳转时自动定位到正确的 Topic Thread 内的消息。
- [ ] **异常/边界**:
  - [ ] **原始消息已删除**: 点击跳转但原消息已被删除 -> Telegram 提示"消息不存在"，App 不崩溃。
  - [ ] **用户已离开群组**: 用户被移出原群聊 -> 跳转时 Telegram 提示"无法访问该群组"，Mini App 不崩溃。
  - [ ] **私聊任务**: 通过转发创建的个人任务（无群聊来源）-> 跳转按钮置灰或隐藏，不提供跳转功能。

### 3.8 唤起 Notion App 进行深度编辑（Story S9）

- [ ] **正常流程**:
  - [ ] 在任务详情页右上角点击「Notion」图标 -> 系统尝试唤起手机上安装的 Notion App 并直接打开该任务对应的 Page。
  - [ ] 用户在 Notion App 中编辑任务字段 -> 返回 Mini App 后刷新可见最新内容。
- [ ] **异常/边界**:
  - [ ] **未安装 Notion App**: 点击图标时设备未安装 Notion -> 降级在浏览器中打开 Notion Web 版。
  - [ ] **任务未同步到 Notion**: 离线模式创建的任务（尚无 Notion Page）-> Notion 图标置灰或点击后提示"任务尚未同步至 Notion"。
  - [ ] **Notion 授权失效**: 任务对应的 Notion Page 权限被撤销 -> 打开后 Notion 端显示无权限提示。

---

## 3.5 🗂️ Telegram Forum/Topic 支持

### 3.5.1 Topic 内任务创建

- [ ] **正常流程**:
  - [ ] 在 Forum 群组的某个 Topic 内引用消息创建任务 -> Bot 在同一 Topic 内回复确认消息，不发到 General。
  - [ ] 任务详情记录所属 Topic 的 Thread ID，后续跳转能正确定位。
  - [ ] 在不同 Topic 内分别创建任务 -> 各自独立，不互相干扰。
- [ ] **异常/边界**:
  - [ ] **Topic 被删除**: 任务创建后 Topic 被删除 -> 任务仍保留在 Mini App 中，但"跳转至对话"功能失效。
  - [ ] **Topic 被关闭**: 在已关闭的 Topic 中尝试创建任务 -> Telegram 阻止发送，Bot 无需特殊处理。

### 3.5.2 Topic 内通知发送

- [ ] **正常流程**:
  - [ ] 任务状态变更 -> 通知消息发送到原任务所属的 Topic 内，而非 General 或私聊。
  - [ ] 评论提醒 -> 同样遵循 Topic 归属规则。
- [ ] **异常/边界**:
  - [ ] **Thread ID 失效**: 原 Topic 已删除 -> 降级发送到 General 或仅通过私聊通知，不阻塞。
  - [ ] **用户无 Topic 权限**: 被指派人无法访问该 Topic -> 私聊通知正常发送，但群内 Topic 无法查看。

### 3.5.3 普通群 vs Forum 群行为差异

- [ ] **正常流程**:
  - [ ] Bot 在普通群（无 Topics）中正常工作，不产生任何 Topic 相关字段或逻辑。
  - [ ] Bot 在 Forum 群中自动识别 Topic 环境，无需额外配置。
- [ ] **异常/边界**:
  - [ ] **群升级为 Forum**: 普通群开启 Topics 功能后 -> 新任务按 Topic 逻辑处理，旧任务仍指向原 General。
  - [ ] **Forum 降级为普通群**: Topics 功能关闭 -> 新任务按普通群逻辑处理，旧任务的 Thread ID 失效但不影响正常展示。

---

## 4. 🟣 阶段四：Notion 深度集成 (Notion Sync)

### 4.1 群组绑定 (`/bind`)

- [ ] **正常流程**:
  - [ ] 管理员选择空白 Database -> 自动初始化 -> 绑定成功。
- [ ] **异常/边界**:
  - [ ] **非管理员操作**: 普通群员点击绑定 -> App 提示 "仅管理员可操作"。
  - [ ] **数据库权限不足**: 选择了一个 Bot 只有 "只读" 权限的库 -> 提示 "Bot 需要编辑权限"。
  - [ ] **初始化失败**: 网络中断导致 Schema 创建一半 -> 提示 "初始化失败，请重试" (支持断点重试)。

### 4.2 双向同步 (Sync)

- [ ] **正常流程**:
  - [ ] TG 改标题/状态 -> Notion 同步；Notion 改标题/状态 -> TG 同步。
- [ ] **异常/边界**:
  - [ ] **Schema 被篡改**: 人工在 Notion 删除了 `Status` 字段 -> TG 修改状态失败，App 提示 "Notion 结构异常"，Bot 报警。
  - [ ] **选项不匹配**: Notion 增加了新的 Status 选项 "Archived" (TG 未知) -> App 显示原值或 "Unknown"，不报错。
  - [ ] **API 限流 (429)**: 短时高频操作 -> App 响应变慢（退避重试中），但最终能同步成功。
  - [ ] **授权被撤销**: Notion 后台断开 Integration -> App 顶部提示 "Notion 连接断开"，同步暂停。

### 4.3 成员映射

- [ ] **正常流程**:
  - [ ] 指派给已绑定用户 -> Notion Assignee 正确。
- [ ] **异常/边界**:
  - [ ] **未绑定用户**: 指派给未绑定 Notion 的用户 -> Notion Assignee 为空，Bot 提示 "UserX 未绑定，无法同步指派"。
  - [ ] **Notion 用户不存在**: 绑定的 Notion 账号被删除 -> 同步指派时忽略该用户，不阻塞其他字段同步。

### 4.4 Notion 侧创建/指派同步（Story N1）

- [ ] **正常流程**:
  - [ ] 在 Notion 中创建任务并设置 Assignee -> 系统在轮询周期内检测到新任务，向对应 Telegram 用户推送通知并在 Mini App 列表中出现。
  - [ ] 若指派多人，所有已绑定的成员都能收到通知并看到任务详情。
- [ ] **异常/边界**:
  - [ ] **Notion 用户未绑定 TG**: 任务指派给未绑定 Telegram 的 Notion 账号 -> Bot 在对应群内提示「请提醒 @User 绑定」，Mini App 仍创建任务但 Assignee 为空。
  - [ ] **多库监听**: 同时监听多个 Database 时新增任务 -> 不串库，任务落在正确的群组视图中。

### 4.5 Notion 侧状态变更同步（Story N2）

- [ ] **正常流程**:
  - [ ] 在 Notion 中将任务状态从「进行中」改为「完成」-> 系统在轮询周期内检测到变更，向 Telegram 相关人推送通知。
  - [ ] Mini App 列表自动将该任务移动到「已完成」分组，无需手动刷新。
  - [ ] 若状态被重新打开（如从「完成」改回「进行中」）-> 同样推送「任务已重新打开」提醒给相关人。
- [ ] **异常/边界**:
  - [ ] **状态选项变更**: Notion 中新增了 TG 未知的 Status 选项（如 "Archived"）-> Mini App 显示"Unknown"或原始值，不报错。
  - [ ] **快速多次变更**: 用户在短时间内多次修改状态 -> 仅推送最终状态，避免消息轰炸。
  - [ ] **轮询延迟**: 系统繁忙导致轮询延迟 -> 用户理解可能存在 1-2 分钟延迟，但最终一定同步。

### 4.6 评论双向同步（Story N3）

- [ ] **正常流程**:
  - [ ] Notion 中新增评论 -> Telegram Bot 向任务创建人及其他指派人推送通知，Mini App 评论区同步出现，并标记来源。
  - [ ] Mini App 中发表评论 -> Notion 页面生成一条由 Bot 代发的评论，带有「From <User>」标记。
- [ ] **异常/边界**:
  - [ ] **权限不足**: 用户在 Notion 仅有评论权限 -> Mini App 提示「权限不足」并阻止状态变更，但发表评论仍可成功。
  - [ ] **重复提醒**: 同一条评论不应触发多次通知；若轮询重复读取，应通过 comment_id 去重。

### 4.7 任务删除与软删除同步（Story S4）

- [ ] **正常流程**:
  - [ ] 任务详情页点击「删除任务」-> 弹出二次确认，确认后在 Mini App 中软删除，并在 Notion 中将任务 Page 标记为 Archived。
  - [ ] Bot 自动在群里回复「任务已删除」或更新原任务消息，相关人员收到通知。
- [ ] **异常/边界**:
  - [ ] **无权限用户**: 非创建人/管理员试图删除 -> App 阻止操作并提示原因。
  - [ ] **Notion 回写失败**: Notion Archive API 调用失败 -> Mini App 回滚删除状态并提示「同步失败，请重试」。

### 4.8 群组解绑与更换数据库（Story G3）

- [ ] **正常流程**:
  - [ ] 管理员在群组设置中点击「更换数据库」-> 系统提示影响范围，确认后成功切换到新 Database，后续新任务写入新库。
  - [ ] 解绑后，Mini App 中清晰展示「未绑定数据库」状态，新任务无法创建，直到重新绑定。
- [ ] **异常/边界**:
  - [ ] **中断切换**: 切换流程中网络断开 -> App 保持旧库绑定，并提示切换失败需重试。
  - [ ] **旧任务追溯**: 更换数据库后，旧库内任务仍可查询但不再同步 -> Mini App 需给出只读提示。

### 4.9 智能选库与 Schema 自动初始化（Story G4）

- [ ] **正常流程**:
  - [ ] 进入绑定流程 -> 自动列出 Bot 已获授权的所有 Database，无需输入 ID。
  - [ ] 选择一个缺少字段的新库 -> 触发「一键初始化」，自动创建 Status、Assignee、ChatLink 等必需字段并完成绑定。
- [ ] **异常/边界**:
  - [ ] **字段创建一半失败**: 网络中断导致初始化部分成功 -> 系统提示「初始化失败，请重试」，并支持再次执行补齐缺失字段。
  - [ ] **授权不足**: 对只读库执行初始化 -> 即时报错并引导管理员在 Notion 中授予编辑权限。

### 4.10 个人默认数据库配置（Story U1）

- [ ] **正常流程**:
  - [ ] 用户在个人设置中选择「默认个人数据库」-> 之后通过转发消息创建的任务默认落入该库。
  - [ ] 修改默认库后，新任务写入新的数据库，旧任务保持不变。
- [ ] **异常/边界**:
  - [ ] **未配置默认库**: 转发消息时未配置 -> Bot 弹出 Database 选择器或提示用户先配置。
  - [ ] **选择失效库**: 默认库在 Notion 中被删除 -> App 提示「默认数据库不可用」并要求重新选择。

### 4.11 待同步任务批量写入（Story O2）

- [ ] **正常流程**:
  - [ ] 离线模式用户绑定 Notion 时，系统扫描出 Pending 任务数量并提示「发现 N 个待同步任务」。
  - [ ] 用户确认后选择目标 Database -> 所有 Pending 任务被批量写入 Notion，标记从「Pending」变为「已同步」。
- [ ] **异常/边界**:
  - [ ] **用户取消**: 在确认弹窗点击取消 -> 不写入 Notion，Pending 标签保持，后续仍可再次触发同步。
  - [ ] **部分失败**: 批量写入过程中某些任务失败 -> 报告具体失败列表，成功的任务保持已同步状态，失败的仍显示 Pending。

### 4.12 连接管理仪表盘（Story M1）

- [ ] **正常流程**:
  - [ ] 在 Mini App -> 设置 -> 连接管理中，展示所有「Telegram 群组 ↔ Notion Database」映射列表，含状态/Token 信息。
  - [ ] 管理员可在此列表中直接跳转到群组设置、解绑或检查同步状态。
- [ ] **异常/边界**:
  - [ ] **权限限制**: 非管理员访问连接管理 -> 只能查看自己有权限的映射，敏感操作按钮置灰。
  - [ ] **状态同步**: 当某个连接 Token 过期 -> 仪表盘中该行显示警告标记，并可一键重新授权。

### 4.13 Bot 被踢出群组处理

- [ ] **正常流程**:
  - [ ] Bot 被管理员踢出群组 -> 系统监听 `my_chat_member` 事件，标记该群组关联关系为"失效 (Inactive)"。
  - [ ] 群组状态失效后 -> 停止对该群组绑定 Database 的轮询，节省资源。
  - [ ] Bot 被重新拉入群组 -> 系统识别重入事件，需管理员在设置页手动点击"恢复连接"。
- [ ] **异常/边界**:
  - [ ] **网络波动误触发**: 短暂网络问题导致误判为被踢 -> 系统采用延迟确认机制，不立即标记失效。
  - [ ] **多次踢入踢出**: 短时间内反复操作 -> 系统以最终状态为准，不发送多次通知。

### 4.14 Notion 端删除任务/Database 处理

- [ ] **正常流程**:
  - [ ] Notion 中任务 Page 被 Archive -> Mini App 同步将对应任务标记为"已归档"或从列表中移除。
  - [ ] Notion 中任务 Page 被永久删除 -> Mini App 中该任务显示"已从 Notion 删除"提示，不再同步。
- [ ] **异常/边界**:
  - [ ] **Database 被删除/移入 Trash**: 系统轮询收到 404 错误 -> 自动暂停该群组的同步任务，向群管理员发送"数据库丢失"警报。
  - [ ] **Database 暂时不可用**: 因网络问题临时 404 -> 系统不立即解绑，采用重试机制确认后再处理。
  - [ ] **误删恢复**: 管理员从 Trash 恢复 Database -> 系统在下次轮询时重新建立连接，无需手动操作。
  - [ ] **权限撤销**: Database 权限被移除 -> 系统收到 403 错误，提示"Notion 权限不足，请检查 Integration 设置"。

---

## 5. 🟤 阶段五：通知系统 (Notifications)

### 5.1 消息推送

- [ ] **正常流程**:
  - [ ] 任务变动 -> 相关人收到私聊卡片；点击 Deep Link 直达详情。
- [ ] **异常/边界**:
  - [ ] **Bot 被拉黑**: 用户 Block 了 Bot -> 后端捕获 403 错误，停止推送，不阻塞队列。
  - [ ] **用户已注销**: 目标账号已删号 -> 标记映射失效。
  - [ ] **自己操作**: 自己修改状态 -> **不应** 收到通知 (防打扰生效)。

### 5.2 通知直达与快速处理（Story S5）

- [ ] **正常流程**:
  - [ ] 收到"新任务指派"通知卡片 -> 卡片下方显示「📂 打开工单」按钮（Deep Link）。
  - [ ] 点击 Deep Link 按钮 -> 直接唤起 Mini App 并自动跳转到该任务的详情页，而非列表页。
  - [ ] 从通知直达的详情页可正常执行「回复评论」或「变更状态」操作。
- [ ] **异常/边界**:
  - [ ] **任务已删除**: 点击 Deep Link 但任务已被删除 -> Mini App 显示"任务不存在"提示并回退到列表页。
  - [ ] **Deep Link 格式错误**: 恶意构造的 Deep Link 参数 -> Mini App 校验失败，提示"无效链接"并进入首页。
  - [ ] **未登录状态**: 新设备点击 Deep Link -> 完成自动登录后再跳转到目标任务详情。

### 5.3 Bot 状态恢复（Block/Unblock）

- [ ] **正常流程**:
  - [ ] 用户 Block Bot 后又 Unblock，重新发送 `/start` -> 系统识别用户回归，状态从"不可达 (Unreachable)"恢复为"活跃 (Active)"。
  - [ ] 状态恢复后，新的任务通知能正常推送到该用户。
- [ ] **异常/边界**:
  - [ ] **未重新 Start**: 用户 Unblock 后未发送 `/start` -> 系统仍标记为不可达，直到用户主动交互。
  - [ ] **历史通知**: Block 期间错过的通知 -> 不补发（或仅补发最近 N 条），避免信息轰炸。

### 5.4 每日摘要 (Story P1)

- [ ] **正常流程**:
  - [ ] 到达设定时间 -> 收到摘要卡片，包含「今日截止」、「已逾期」、「待处理」三类任务概览。
  - [ ] **可配置时间**: 用户在设置页可修改摘要推送时间（如 8:00 / 9:00 / 10:00），保存后生效。
- [ ] **异常/边界**:
  - [ ] **无待办任务**: 今日无任何待办 -> 不发送摘要（或发送 "今日无待办，享受生活"）。
  - [ ] **时区差异**: 用户在 UTC-5，服务器在 UTC+8 -> 推送时间应匹配用户当地的设定时间。

### 5.5 时区处理

- [ ] **正常流程**:
  - [ ] 在 Mini App 中设置截止日期"明天 9:00" -> 系统根据用户本地时区解析并存储为 UTC 时间。
  - [ ] 不同时区用户查看同一任务的截止日期 -> 各自按本地时区正确显示。
  - [ ] 每日摘要按用户所在时区的上午 9:00 发送，而非服务器时区。
- [ ] **异常/边界**:
  - [ ] **时区信息缺失**: 用户未设置时区 -> 默认使用 Notion Workspace 时区或 UTC+0。
  - [ ] **跨时区协作**: A 用户设置"今天截止"（UTC+8），B 用户（UTC-5）查看 -> 日期显示正确转换，不产生歧义。

### 5.6 用户名变更稳定性 (FAQ Q11)

- [ ] **正常流程**:
  - [ ] 用户修改 Telegram Username -> 系统基于 User ID 识别，任务列表、指派关系不受影响。
  - [ ] 用户修改 Notion 绑定邮箱 -> 系统基于 Notion User ID 识别，同步正常。
- [ ] **异常/边界**:
  - [ ] **显示名更新**: 用户改名后，新的任务应显示新名字（如列表中的 Assignee 显示名）。

---

## 6. ⚙️ 阶段六：设置页完整性 (Settings Page)

### 6.1 设置页结构 (PRD 5.2)

- [ ] **正常流程**:
  - [ ] 点击「设置」入口 -> 展示三大板块：「连接管理」、「个人配置」、「群组设置」。
  - [ ] **连接管理**: 列出群组 ↔ Database 映射，支持解绑/跳转。
  - [ ] **个人配置**: 默认数据库、每日摘要时间、时区设置。
  - [ ] **群组设置**: 仅在群聊环境可见，用于绑定/更换 Database。
- [ ] **异常/边界**:
  - [ ] **无管理权限**: 普通用户进入「连接管理」-> 只能查看自己有权限的映射，解绑按钮置灰。
  - [ ] **未绑定 Notion**: 进入「个人配置」-> 默认数据库选项置灰，并提示先绑定 Notion。

### 6.2 Notion 特殊字段她理 (FAQ Q22)

- [ ] **正常流程**:
  - [ ] **Formula 字段**: Mini App 能展示公式计算结果（如“剩余天数”）。
  - [ ] **Rollup 字段**: Mini App 能展示汇总结果。
- [ ] **异常/边界**:
  - [ ] **编辑只读字段**: 尝试编辑 Formula/Rollup -> UI 置灰禁用，不允许修改。

### 6.3 Markdown/Rich Text 格式处理 (FAQ Q17)

- [ ] **正常流程**:
  - [ ] **TG -> Notion**: Telegram 中的粗体、链接 -> 转为 Notion Rich Text 写入。
  - [ ] **Notion -> Mini App**: Notion Block/Rich Text -> Mini App 直接渲染，样式与 Notion 原生一致。
- [ ] **异常/边界**:
  - [ ] **无法转换**: TG 特殊格式无法转为 Notion -> 作为纯文本写入，不报错。

---

## 7. 📝 验收总结 (Sign-off)

请逐项核对上述 **正常 + 异常** 场景。

| 模块        | 测试通过率 | 关键 Bug ID | 签字 |
| :---------- | :--------- | :---------- | :--- |
| Bot 指令    |            |             |      |
| Mini App    |            |             |      |
| Forum/Topic |            |             |      |
| Notion 同步 |            |             |      |
| 通知系统    |            |             |      |
| 设置页      |            |             |      |

**测试人**: ********\_\_\_\_******** **日期**: 2025-**_-_**
