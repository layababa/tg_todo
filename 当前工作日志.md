## 2025-11-24 · Backend-First Sprint

### 核心策略
- 沿用 `docs/server/backend-development-plan.md` 的 16 步，逐模块完成服务端 + API，再迁移 `prototype/` 对应页面到前端工程。
- 当前阶段聚焦 **后端基础设施 → Onboarding/API 契约**；前端 `web/src` 暂不恢复，仅保留 Prototype 参考。
- 每完成一个模块：更新本日志、同步 `docs/document-map.md`、整理下一页面的前端迁移 checklist。

---

### 当前聚焦模块
1. **基础设施 & 健康检查**（✅ 已完成并验收）  
   - 目标：`cmd/api`/`cmd/bot` 启动体、config、middleware、`/healthz`，让现有 Go 测试转绿，Dockerfile 可用。
   - 验收状态：✅ 通过手动验收，`/healthz` 接口正常返回，DB 和 Redis 连接正常。
2. **身份 & Onboarding API**（✅ 已完成）  
   - 目标：实现 `/auth/status`、`/auth/notion/url`、`/auth/notion/callback`，完成 Telegram init data 校验、用户建档、Notion token 管理。

### 后续模块排期
1. Telegram 更新接入 & 去重（模块 3）
2. 任务创建 / 上下文抓取（模块 4）
3. Deep Link / Start Param 路由（模块 5）
4. Tasks 列表 & 详情 API（模块 9，依赖任务模型）

> 完成每个模块后：更新本日志、补 `docs/document-map.md`、整理对应 Prototype 页面迁移 checklist。

---

### 模块任务板（按优先级 · 详细拆解）

#### 1) 基础设施 & 健康检查（✅ 已验收通过）
- ✅ `cmd/api` 启动程序：解析 config、初始化 logger、注册 Gin 中间件、暴露 `/healthz`。
- ✅ `internal/config`：实现 `Load()` 支持文件 + env fallback（满足 `config_test.go`）；补 `config/default.yml`（示例配置 + ENV 映射）。
- ✅ HTTP 中间件：
  - `middleware/request_id`：生成/透传 `X-Request-ID`，供日志/响应使用。
  - `middleware/recovery`：匹配测试期望，输出 `{success:false,error:{code:...},meta:{request_id}}`。
- ✅ Healthz handler：依赖 `healthz.Dependency` 接口注入 DB/Redis stub，返回版本、git hash、依赖状态。
- ⏳ `cmd/bot` 占位：先能加载 config+logger+DB，后续模块复用。
- ✅ `server/pkg/db/db.go` 已可复用；需在 `cmd/api` wiring 中接入 Postgres/Redis 配置（默认从 env, 支持 `DATABASE_DSN` 等）。
- ✅ 修正 go module name 为 `github.com/layababa/tg_todo/server`。
- ✅ Dockerfile 构建通过。
- ✅ Docker Compose 配置修复：添加 Redis 服务，修正环境变量映射。
- ✅ 手动验收通过：`curl http://localhost:8081/healthz` 返回正常。

#### 2) 身份 & Onboarding API（进行中）

**步骤 1: 数据模型与 Repository** ✅ 已完成
- ✅ 创建 `internal/models/user.go`: 定义 `User` 和 `UserNotionToken` GORM 模型
- ✅ 创建 `internal/repository/user_repository.go`: 实现 UserRepository 接口
  - `FindByTgID(ctx, tgID)` - 根据 Telegram ID 查找用户
  - `Create(ctx, user)` - 创建新用户
  - `Update(ctx, user)` - 更新用户信息
  - `FindNotionToken(ctx, userID)` - 查找 Notion token
  - `SaveNotionToken(ctx, token)` - 保存/更新 Notion token

**步骤 2: Telegram Init Data 校验** ✅ 已完成
- ✅ 创建 `pkg/telegramauth/init_data.go`: 实现签名验证
  - `ParseInitData(raw string)` - 解析 init data 并解析 User JSON
  - `Validate(botToken string)` - HMAC-SHA256 签名验证
  - `IsExpired(maxAge)` - 检查是否过期
- ✅ 创建 `pkg/telegramauth/init_data_test.go`: 完整单元测试覆盖
  - 测试 User JSON 解析
  - 测试有效/无效签名验证
  - 测试过期检测
  - 所有测试通过 ✅

**步骤 3: Token 加解密工具** ✅ 已完成
- ✅ 2025-11-24 · Codex · 验收结果：审阅 `pkg/crypto/aes.go`/`pkg/crypto/aes_test.go` 并执行 `go test -cover ./pkg/crypto`（82.6%），确认 AES-256-GCM、nonce 随机化与错误处理满足需求。
- ✅ 创建 `pkg/crypto/aes.go`: AES-256-GCM 加解密
  - `Encrypt(plaintext, key string)` - 加密 token，返回 base64
  - `Decrypt(ciphertext, key string)` - 解密 token
  - `GenerateKey()` - 生成32字节随机密钥
- ✅ 创建 `pkg/crypto/aes_test.go`: 完整测试覆盖
  - 加解密往返测试
  - 错误密钥无法解密测试
  - 无效输入处理测试
  - 随机性验证测试
  - 性能基准测试
- ✅ 测试覆盖率: 82.6% (超过80%目标)
- ✅ 所有测试通过

**步骤 4: Notion OAuth Client** ✅ 已完成
- ✅ 2025-11-24 · Codex · 验收结果：检查 `pkg/notion/oauth.go`/`oauth_test.go` 与 `internal/config/config.go`、`go.mod` 更新，并运行 `go test -cover ./pkg/notion`（76.7%），确认授权 URL 生成、Token 交换响应解析与配置项映射符合需求。
- ✅ 创建 `pkg/notion/oauth.go`: Notion OAuth 流程
  - `GenerateAuthURL(redirectURI, state)` - 生成授权 URL
  - `ExchangeCode(code)` - 交换 code 获取 token
  - `TokenResponse` - 包含 access_token、workspace 信息等
- ✅ 添加 Notion 配置到 `internal/config/config.go`
  - `notion.client_id`, `notion.client_secret`, `notion.redirect_uri`
  - `telegram.bot_token`, `encryption.key`
- ✅ 创建 `pkg/notion/oauth_test.go`: 完整测试覆盖
  - URL 生成测试
  - Token 响应解析测试
  - 配置结构测试
- ✅ 添加 `dstotijn/go-notion` SDK 依赖
- ✅ 测试覆盖率: 76.7%
- ✅ 所有测试通过

**步骤 5: Auth Middleware** ✅ 已完成
- ✅ 2025-11-24 · Codex · 验收结果：审阅 `internal/server/http/middleware/auth.go`/`auth_test.go`（含 mock UserRepository、buildUserName/Context 工具函数）并运行 `go test ./internal/server/http/middleware`，确认中间件校验 header/签名/过期、创建或加载用户并注入上下文的逻辑生效。
- ✅ 创建 `internal/server/http/middleware/auth.go`
  - `TelegramAuth()` 中间件 - 验证 init data 并加载用户
  - 从 `X-Telegram-Init-Data` header 读取并验证
  - 自动创建新用户或加载已存在用户
  - 将 user 存入 gin.Context
  - 检查签名、过期时间（24小时）
- ✅ 创建 `internal/server/http/middleware/auth_test.go`
  - Mock UserRepository 用于测试
  - 测试缺失 init data 的错误处理
  - 测试用户名构建逻辑（buildUserName）
  - 测试上下文用户获取（GetUserFromContext）
- ✅ 测试覆盖率: 53.3%
- ✅ 所有测试通过

**步骤 6: Auth Handlers 实现** ✅ 2025-11-24 · Codex
- ✅ 创建 `internal/server/http/handlers/auth/handler.go`
  - `GetStatus` 输出用户信息、pending sync placeholder、`redirect_hint`；`GetNotionAuthURL` 生成带 HMAC state 的 OAuth URL；`NotionCallback` 解码 state → `tg_id`、调用 Notion OAuth、AES-256-GCM 加密 token、Upsert `user_notion_tokens` 并更新 `notion_connected`。
- ✅ 创建 `internal/server/http/handlers/auth/handler_test.go`：覆盖状态查询、URL 生成并验证 state 可还原、回调持久化成功/异常路径。
- ✅ 在 `cmd/api/main.go` 中注册路由与依赖：引入 GORM repository、构建 Handler、将 `/auth/*` 绑定 `TelegramAuth` 中间件。
- ✅ 测试：`go test ./...`（server/）全部通过。

**步骤 7: 数据库迁移集成** ✅ 2025-11-24 · Codex
- ✅ 引入 `github.com/golang-migrate/migrate/v4` 及 `iofs`/`postgres` 驱动，新增 `migrations/runner.go`/`runner_test.go`：`Run()` 使用 embed.FS + go-migrate 执行所有 SQL，含空 DB 校验单测。
- ✅ `cmd/api/main.go` 在建立数据库连接后立即调用 `migrations.Run`，确保 `/auth/*` 等模块使用最新 schema。
- ✅ 测试：`go test ./...`（server/）覆盖 migrations 包。

**步骤 8: 集成测试** ✅ 2025-11-24 · Codex
- ✅ 创建 `internal/server/http/handlers/auth/integration_test.go`：使用 testcontainers 启动 Postgres，挂载真实 `TelegramAuth` 中间件 + Auth handler，走完 `/auth/status → /auth/notion/url → /auth/notion/callback` 流程，并断言用户/Notion token 实际落库与 AES 解密结果。
- ✅ `migrations/sql/*.up.sql`：将 SQL 迁移移入子目录并采用 go-migrate 约定的 `*.up.sql` 命名，`migrations/runner.go` 通过 embed `iofs` 加载；新增 `runner_test.go` 覆盖 embed 可读性。
- ✅ 测试：`CGO_ENABLED=0 go test ./...`（默认 `go test` 受 Xcode License 限制无法构建 `runtime/cgo`，已记录原因）。

**前端配套（Onboarding）** ✅ 2025-11-24 · Codex
- ✅ 在 `web/` 目录重建 Vue + Pinia + Router + DaisyUI 工程骨架，新增 `src/pages/OnboardingPage.vue` 对接 `/auth/status`、`/auth/notion/url` 并处理 `start_param`/游客模式，`window.tgTodo.setMockInitData()` 便于测试。
- ✅ 新增 `src/store/auth.ts`、`src/utils/initData.ts`、`src/api/client.ts`，统一封装 Telegram init data 管理与 axios header 注入。
- ✅ 运行 `npm run build`（web/）验证前端构建通过。

**环境变量需求**（需添加到 `.env.test` 和 `config/default.yml`）:
- `TELEGRAM_BOT_TOKEN` - Telegram Bot Token
- `NOTION_CLIENT_ID` - Notion OAuth Client ID
- `NOTION_CLIENT_SECRET` - Notion OAuth Secret
- `NOTION_REDIRECT_URI` - OAuth 回调 URL
- `ENCRYPTION_KEY` - 32字节加密密钥（用于 token 加密）

**依赖清单**:
- ✅ `gorm.io/gorm` - ORM
- ✅ `gorm.io/driver/postgres` - PostgreSQL 驱动
- ✅ `github.com/golang-migrate/migrate/v4` - 数据库迁移执行（embed + go-migrate）
- ✅ `github.com/dstotijn/go-notion` - Notion SDK（OAuth 流）
- ✅ `github.com/testcontainers/testcontainers-go` - 集成测试（Postgres + Ryuk 生命周期）

#### 3) Telegram 更新接入 & 去重（下一步）
- ⏳ 计划：Gin handler + `/webhook/telegram`，接收 `update`，接入 Redis `SETNX` 幂等、原始 update 落库。
- ⏳ Webhook 安全：校验 Bot Token、支持长轮询 fallback。
- ⏳ 命令路由：/start、/help、群成员状态事件写审计。

#### 4) 任务创建 & 上下文抓取
- ⏳ 计划：reply/forward/@Bot 解析，任务建模（`tasks`、`task_context_snapshots`、`task_assignees`）、任务落库（支持离线 Pending 状态）。
- ⏳ Telegram API：抓取触发消息前 10 条上下文，生成 `chat_jump_url`。

#### 5) Deep Link / Start Param
- ⏳ 计划：`/bootstrap` 接口，解析 `start_param`，返回前端路由；生成 `task_{id}`、`group_{id}` deep link。

#### 6) Tasks 列表 & 详情 API
- ⏳ 列表：`GET /tasks` 视图过滤、分页、空状态、离线任务标识。
- ⏳ 详情：`GET /tasks/{id}`，包含 context/description/comments；`PATCH/DELETE`、评论 CRUD。

> 模块 7-16（Notion OAuth/库管理/群组/指派/评论/通知/同步(含手动)/Digest/设置/可观测）沿 backend plan 推进，待前述模块稳定后展开，每个模块提前梳理数据模型与依赖。

---

### 其他角色同步
- **产品**：PRD/FRD/Prototype 继续作为需求源，在后端模块完成时再补异常文案；暂不新增改动。
- **前端**：保持暂停；待 Onboarding + Tasks API 稳定后再恢复 `web/src`，并修复 `web/Dockerfile` 缺文件问题。
- **DevOps**：准备 `docs/deploy/`、CI 草稿、daisyUI 模板来源说明。
- **QA**：当前重点是 Go 单测与接口验证；前端 Vitest/Cypress 等待接口落地后恢复。

---

### 支撑工作 & 待办
- 📦 **数据库迁移**：为 `users`, `user_notion_tokens`, `tasks` 等表编写 `migrations/*.sql`；在 `cmd/api` 启动时执行 embed 迁移。
- 🛠 **DevOps**：
  - 🔄 `docs/deploy/`：记录 docker-compose、环境变量、daisyUI 模板来源、构建命令、端口、健康检查配置。
  - 🔄 `web/Dockerfile` 缺少 `daisyUI.template.css`：决定文件来源（版本库 or npm 脚本），补文件或调整 COPY。
  - ⏳ Build pipeline：准备 GitHub Actions/GitLab CI 草稿（lint/test/build/publish）。
- 📋 **文档**：完善 `docs/document-map.md` 对应条目、在 API 实现后补充示例响应。
- 🧪 **测试/QA**：
  - 🔄 让现有 Go 测试通过后，新增覆盖率门槛（≥60%）检查。
  - ⏳ 准备 Postman/HTTPie collection，用于验证 `/auth/*`、`/healthz`、后续 `/tasks` 接口。
  - ⏳ 规划 Telegram sandbox 脚本，验证 webhook/通知链路。
- 🎨 **前端待办**（暂缓执行）：
  - 找回/重建 `web/src`（Vue + Pinia + Router + DaisyUI）。
  - 为每个已完成 API 的页面编写数据适配层、Pinia store、组件。
  - 迁移 Prototype 的交互动效（pull-to-refresh、HUD、modal）。

---

### 48h 行动清单
1. **Infra 完成度 ≥90%**  
   - `cmd/api` 可运行，`/healthz` 返回版本、git hash、依赖列表。  
   - `make test` 全绿（config/middleware/healthz）。  
   - Dockerfile 可以构建并运行 `api` 容器，读取 env + 打印结构化日志。
2. **配置 & 依赖注入**  
   - 定义 `.env.example` / `config/default.yml`，覆盖 HTTP/DB/Redis/Telegram/Notion 配置。  
   - 在启动流程中初始化 Postgres/Redis 客户端并注入 healthz 依赖。
3. **Auth 模块预备**  
   - 确定 Telegram init data 校验方案，输出 `pkg/telegramauth` 接口。  
   - 起草 `users` / `user_notion_tokens` migration 与 repository 接口，为下一迭代的 `/auth/*` 实现做准备。

> 完成以上 48h 目标后，再拉通 Onboarding API、计划 Telegram webhook 模块，并视情况更新前端迁移节奏。

### 临时插入任务 (2025-11-24)
- ✅ **PRD & 文档调整**：
  - 目标：支持无 Notion 关联时的任务创建（持久化至 Mini App 服务端），以及后续的手动关联与同步。
  - 涉及文档：`docs/prd/prd.md`, `docs/frontend/frontend_requirements.md`。
  - 状态：✅ 已完成（已修正术语：明确为 Notion 同步状态，而非云端存储状态）。
- ✅ **后端文档配套更新**：
  - 目标：更新 DB Schema、API 文档与开发计划以支持离线任务与手动同步。
  - 涉及文档：`docs/server/db-schema.md`, `docs/server/api-by-page.md`, `docs/server/backend-development-plan.md`。
  - 状态：✅ 已完成。
