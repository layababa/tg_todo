## 2026-01-06

### ✅ 修复 Bot 群聊触发逻辑

- **时间**: 2026-01-06 01:10
- **负责人**: AI Agent
- **内容**:
  - **问题修复**: 修复了 Bot 在群聊中会自动处理所有转发消息（包括非文本消息如图片）并报错 "⚠️ 暂不支持转发非文本消息" 的问题。
  - **逻辑调整**:
    - **群聊**: 忽略所有转发消息，除非显式 Mention 或回复 Bot（符合 PRD S1/S2）。
    - **私聊**: 保持自动处理转发消息的功能（Story S7）。
  - **功能增强**: 在**私聊**中支持转发带标题 (Caption) 的图片/视频，Bot 会提取标题作为任务内容。
  - **单元测试**: 新增 `server/internal/server/http/handlers/telegram/webhook_logic_test.go` 验证转发逻辑条件。
- **状态**: ✅ 已完成 (Verified)
- **修改文件**:
  - `server/internal/server/http/handlers/telegram/webhook.go`
  - `server/internal/server/http/handlers/telegram/webhook_logic_test.go` (新建)

### ✅ 日历订阅功能 (Calendar Sync)

- **时间**: 2026-01-06 01:35
- **负责人**: AI Agent
- **内容**:
  - **功能实现**: 实现了 Webcal 日历订阅功能，用户可在系统日历中自动同步待办任务。
  - **数据库**: 新增 `calendar_token` 字段到 `users` 表。
  - **后端**: 新增 `GET /cal/:token/todo.ics` 返回 ICS 格式日历，`POST /api/me/calendar-token` 生成订阅链接。
  - **前端**: Settings 页面新增「日历同步」模块，一键启用订阅。
- **状态**: ✅ 已完成 (Build Verified)
- **修改文件**:
  - `server/migrations/sql/000009_add_calendar_token.up.sql` (新建)
  - `server/internal/models/user.go`
  - `server/internal/repository/user_repository.go`
  - `server/internal/server/http/handlers/calendar/handler.go` (新建)
  - `server/internal/config/config.go`
  - `server/cmd/api/main.go`
  - `web/src/api/user.ts`
  - `web/src/pages/SettingsPage.vue`

### ✅ CI 修复与测试 Mock 补全

- **时间**: 2026-01-06 02:35
- **负责人**: AI Agent
- **内容**:
  - **Mock 修复**: 解决了因 UserRepository 接口新增 `FindByCalendarToken` 方法导致的多个测试包编译失败问题。
  - **涵盖模块**:
    - `server/internal/server/http/handlers/auth`
    - `server/internal/service/notion`
    - `server/internal/service/task`
  - **验证**: 本地运行 `go test ./server/...` 全部通过。
- **状态**: ✅ 已完成 (Fix Committed)
- **修改文件**:
  - `server/internal/server/http/handlers/auth/handler_test.go`
  - `server/internal/service/notion/service_test.go`
  - `server/internal/service/task/creator_test.go`

### ✅ HomePage Header 截断修复

- **时间**: 2026-01-06 03:12
- **负责人**: AI Agent
- **内容**:
  - **问题**: 用户反馈 HomePage 上滑时，分组 Tab 栏（"自己创建"等）被截断一半。
  - **原因**: Header 高度是固定的，但当显示 "分组导航条" (Anchor Chips) 时，内容高度增加导致溢出。
  - **修复**: 在 `HomePage.vue` 中实现动态高度计算。当存在多个分组时，自动增加 48px Header 高度。
  - **效果**: 确保在任何状态下（收缩/展开），所有导航元素均完整可见。
- **状态**: ✅ 已完成 (Deployed)
- **修改文件**:
  - `web/src/pages/HomePage.vue`

### ✅ Android 后退按钮体验优化

- **时间**: 2026-01-06 03:22
- **负责人**: AI Agent
- **内容**:
  - **功能**: 接管 Android 硬件后退按钮逻辑，防止误触直接退出 Mini App。
  - **逻辑**:
    - **非首页**: 点击后退 -> 路由返回上一页。
    - **首页**: 点击后退 -> 显示 "再按一次退出" 提示。
    - **双击退出**: 在首页 2 秒内再次点击后退 -> 关闭 Mini App。
  - **实现**: 新增 `useBackButton` Composable 全局管理 Telegram BackButton 状态。
- **状态**: ✅ 已完成 (Deployed)
- **修改文件**:
  - `web/src/composables/useBackButton.ts`
  - `web/src/App.vue`

### ✅ 修复发布后 Chunk 加载错误 (Hotfix)

- **时间**: 2026-01-06 03:26
- **负责人**: AI Agent
- **内容**:
  - **问题**: 生产环境发布新版本后，用户在未手动刷新页面的情况下从缓存加载旧的 `index.html`，导致跳转新页面（Lazy Load）时请求到已被删除的旧 Hash JS 文件，出现白屏或报错。
  - **修复**: 在 Vue Router 全局添加 `onError` 钩子，捕获 `Failed to fetch dynamically imported module` 及相关 CSS 加载错误。一旦捕获，自动执行 `window.location.reload()` 强制刷新当前页面。
- **状态**: ✅ 已完成 (Deployed)
- **修改文件**:
  - `web/src/router/index.ts`

## 2025-12-28

### ✅ Bot 群聊交互优化 (Bot Interaction)

- **时间**: 2025-12-28 00:30
- **负责人**: AI Agent
- **内容**:
  - **Inline Mode 创建任务**: 支持通过 Inline Query (`@Bot <text>`) 直接展示 "创建任务" 选项，点击后发送 `/todo <text>` 指令。
  - **Bot 提及过滤**: 优化群聊消息处理逻辑。当用户发送 `@Bot MyTask` 时，自动剥离 Bot 用户名，防止任务标题包含 Bot 名字或 Bot 被错误指派为负责人。
  - **单元测试**: 新增 regex 逻辑的单元测试，覆盖多种提及场景（开头、结尾、中间、忽略大小写等）。
- **状态**: ✅ 已完成 (Verified)
- **修改文件**:
  - `server/internal/server/http/handlers/telegram/webhook.go`
  - `server/internal/server/http/handlers/telegram/webhook_custom_test.go` (New Test)

## 2025-12-27

### ✅ 首页任务列表重构 (Home Page Refactor)

- **时间**: 2025-12-27 19:00
- **负责人**: AI Agent
- **内容**:
  - **交互重构**: 移除分组折叠功能，改为默认展开；去除 Sticky Header 的吸顶效果，改为自然滚动。
  - **样式优化**:
    - **Solid Header**: 强制顶部导航栏为纯色不透明背景，解决滚动时内容透明叠加的视觉问题。
    - **Header Layout**: 将 Anchor Chips (快速定位锚点) 移至顶部固定区域，不再随列表滚动。
    - **Alignment**: 这是一个像素级对齐优化，将分组标题左内边距调整为 32px，与任务卡片文字垂直对齐。
    - **Tab Logic**: 实现了 "指派给我"、"我创建的"、"已完成" 三个独立 Tab，支持服务端计数与状态过滤。
  - **Bug 修复**: 修复了 Header 高度过大导致布局错乱的问题；修复了 Sticky Header 遮挡内容的问题。
- **状态**: ✅ 已完成 (Deployed)
- **修改文件**:
  - `web/src/pages/HomePage.vue`
  - `web/src/styles/main.css` (Cleanup)
  - `server/internal/repository/task.go` (ListByUser Sorting)

### 💡 需求捕获: AI 辅助上下文分析

- **时间**: 2025-12-27 14:18
- **负责人**: AI Agent
- **内容**:
  - 捕获新需求：利用 AI 分析群聊上下文（前 10 条消息）。
  - 功能点：
    1. **智能定级**: 自动推断 High/Medium/Low。
    2. **智能概述**: 生成摘要并追加到 Description。
  - 交互模式：静默、异步执行，不阻塞用户主流程。
  - 产出文档：`docs/backlog/20251227_ai_context_analysis.md`
- **状态**: ✅ 已归档 (Backlog)

## 2025-12-24

### ✅ UI 性能优化与交互升级

- **时间**: 2025-12-24 19:50
- **负责人**: AI Agent
- **内容**:
  - **性能优化 (Fix Detail Page Lag)**: 修复详情页进入时的卡顿问题。采用**分步渲染 (Staged Loading)** 策略，优先渲染核心内容，延迟渲染评论与描述，大幅提升 TTI (Time to Interactive)。
  - **iOS 风格过渡 (Motion)**: 废弃渐变过渡，实现 iOS 原生风格的侧滑过渡 (Slide Over) 与视差效果 (`translate3d`)，移除 `mode="out-in"` 以支持并行与手势操作。
  - **交互修复 (Scroll Interaction)**:
    - 修复了因绝对定位导致的首页顶部栏无法自动折叠问题（改为监听容器滚动）。
    - 修复了 FAB (创建按钮) 随页面滚动的问题（将 FAB 移出滚动容器）。
  - **体验微调**:
    - 禁用启动页 (Onboarding) 的进入动画，避免违和感。
    - 详情页描述编辑框支持自动高度调整。
- **修改文件**:
  - `web/src/App.vue`: 全局过渡逻辑、布局结构。
  - `web/src/pages/HomePage.vue`: 滚动监听、FAB 定位。
  - `web/src/pages/TaskDetailPage.vue`: 分步加载逻辑、骨架屏。
  - `web/src/styles/main.css`: iOS 动画样式。

### 🐛 Bug 修复

- ✅ **Story S1/S2 · 群聊任务创建触发逻辑**

  - 修复了 Bot 在群聊中无法响应 `@Bot + 文本` 消息的问题
  - 原逻辑要求必须是回复消息才触发任务创建，不符合 PRD 要求
  - 新增 `shouldCreateTask()` 函数，正确判断以下场景：
    - 群聊中 `@Bot + 文本` → 创建任务
    - 群聊中 `Reply + @Bot` → 创建任务
  - 修改文件：`server/internal/server/http/handlers/telegram/webhook.go`

- ✅ **数据库 Schema · group_id 类型不匹配**

  - 修复了 `tasks.group_id` 类型错误导致的任务创建失败
  - 问题：`groups.id` 是 TEXT（存储 Telegram Chat ID），但 `tasks.group_id` 定义为 UUID
  - 解决方案：
    - 创建迁移 `000006_fix_group_id_type.up.sql` 将 `tasks.group_id` 改为 TEXT
    - 更新 `repository/task.go` 中的 GORM 类型标签
  - 修改文件：
    - `server/migrations/sql/000006_fix_group_id_type.up.sql` (新增)
    - `server/migrations/sql/000006_fix_group_id_type.down.sql` (新增)
    - `server/internal/repository/task.go`

- ✅ **用户体验优化 · 群聊交互引导**

  - 优化 Bot 入群欢迎消息，提供详细的使用说明
  - 优化任务创建成功后的回复，显示更多有用信息
  - 改进内容：
    - 入群欢迎：详细说明如何创建任务、绑定 Notion，并提供绑定按钮
    - 任务创建回复：显示指派人数、同步状态，提供查看任务详情按钮
  - 修改文件：`server/internal/server/http/handlers/telegram/webhook.go`

- ✅ **Bug 修复 · Telegram 按钮类型错误**

  - 修复了 `BUTTON_TYPE_INVALID` 错误导致的群聊无响应问题
  - 问题：当 `webAppURL` 未配置时，`buildWebAppMarkup` 返回 nil，但代码仍尝试发送导致 API 报错
  - 解决方案：检查 markup 是否为 nil，未配置时提供命令行指引而不发送按钮
  - 修改文件：`server/internal/server/http/handlers/telegram/webhook.go`

- ✅ **产品策略调整 · 弱化 Notion 功能强调**
  - 根据产品定位调整消息文案，强调本地任务管理为核心功能
  - Notion 同步定位为"锦上添花"的可选增强功能
  - 改进内容：
    - 入群欢迎：移除 Notion 详细说明，改为"高级设置"按钮
    - 任务创建回复：移除 Notion 提及，仅在已同步时显示"✓ 已同步"
  - 修改文件：`server/internal/server/http/handlers/telegram/webhook.go`

---

# 当前工作日志

## 2025-12-22

## 2025-12-23

### ✅ 添加前端权限不足提示

- **时间**: 2025-12-23 22:52
- **负责人**: AI Agent
- **内容**:
  - 在任务详情页面的修改操作中添加 403 错误检查
  - 修改 `cycleStatus`、`updateDueDate`、`clearDueDate` 函数
  - 当用户没有权限时，显示提示："权限不足：您没有权限修改此任务。只有创建人、指派人或群管理员可以修改任务。"
  - 修复 TypeScript 类型错误（在 `PatchTaskRequest` 中添加 `due_at` 字段）
- **修改文件**:
  - `web/src/pages/TaskDetailPage.vue`
  - `web/src/api/task.ts`

## 2025-12-22

### ✅ 实现任务修改权限控制

- **时间**: 2025-12-22 19:45
- **负责人**: AI Agent
- **内容**:
  - 创建权限校验函数 `CanModifyTask`（检查用户是否为创建人、指派人或群管理员）
  - 创建 UserGroup Repository 实现用户群组关系查询
  - 在任务更新 API (`PATCH /tasks/:task_id`) 中添加权限校验
  - 在任务删除 API (`DELETE /tasks/:task_id`) 中添加权限校验
  - 无权限时返回 403 Forbidden 错误，提示"您没有权限修改/删除此任务"
- **权限规则**: 只有群 Admin、创建人、指派人可以修改任务，其他人只能查看和评论
- **修改文件**:
  - `server/internal/service/task/permission.go` (新建)
  - `server/internal/repository/user_group_repository.go` (新建)
  - `server/internal/server/http/handlers/task/handler.go`
  - `server/cmd/api/main.go`
- **下一步**: 用户测试权限功能

### ✅ 改用 Telegram 深链接格式

- **时间**: 2025-12-22 19:32
- **负责人**: AI Agent
- **内容**:
  - 将任务链接从 WebApp URL 格式改为 Telegram 深链接格式
  - 旧格式：`https://ddddapp.zcvyzest.xyz?tg_web_app_start_param=task_xxx`
  - 新格式：`https://t.me/tg2no_test_bot?startapp=task_xxx`
  - 符合 Telegram Mini App 官方推荐的 startapp 深度链接标准
- **修改文件**: `server/internal/server/http/handlers/telegram/webhook.go`

### ✅ Bot 群聊回复文案优化完成

- **时间**: 2025-12-22 19:30
- **负责人**: AI Agent
- **内容**:
  - 移除了 Notion 相关提示
  - 添加了任务页 URL（Mini App 链接）
  - 当有指派人时，会 @ 对应用户并提示"请点击链接查收任务"
  - 优化了不同场景下的文案展示
- **修改文件**: `server/internal/server/http/handlers/telegram/webhook.go`

### ✅ 修复群聊 WebApp 按钮错误

- **时间**: 2025-12-22 19:25
- **负责人**: AI Agent
- **问题**: Bot 在群聊中回复时出现 `BUTTON_TYPE_INVALID` 错误
- **根本原因**: Telegram Bot API 不支持在群聊中使用 `web_app` 类型的按钮，只能在私聊中使用
- **解决方案**:
  - 在群聊中不使用 WebApp 按钮，改为发送纯文本消息
  - 在私聊中可以正常使用 WebApp 按钮
- **修改文件**: `server/internal/server/http/handlers/telegram/webhook.go`, `server/internal/service/telegram/client.go`

### ✅ Telegram Webhook 配置完成

- **时间**: 2025-12-22 19:16
- **负责人**: AI Agent
- **内容**:
  - 成功设置 Telegram Webhook URL 为 `https://ddddapi.zcvyzest.xyz/webhook/telegram`
  - 修正了初始配置错误（从 `/api/webhook/telegram` 改为 `/webhook/telegram`）
  - 重新构建并部署后端服务，包含所有 Bug 修复（群聊任务创建、数据库类型、按钮错误）
  - 验证通过：待处理消息数为 0，无错误
  - 环境变量 `TELEGRAM_WEBHOOK_URL` 已更新到 `server/.env`
- **下一步**: 在 Telegram 群聊中测试任务创建功能

## 2025-12-10 · Database-First Roadmap Refinement

### 当前状态

- **UI Migration**: `✅ 已完成` (Home, Detail, Settings, Onboarding 均已复刻 Prototype 样式)。
- **API Integration**: `🔄 进行中` (Task Detail 读取已完成)。
- **Focus**: 转向 **本地优先 (Database-First)** 策略，弱化 Notion 同步。

---

### ⏳ 稍后开发 (Backlog & Sync)

- [x] **Module 16 · Notion→TG 回流**
  - Poller Service 已实现 (Module 16)，支持 Notion 状态变更同步回 Telegram。
- [x] **Story S8 · 按 Database 筛选视图**
  - 首页已支持 Database 筛选器，API 已支持 `database_id` 过滤。
- [x] **Story S9 · 打开 Notion 深度编辑**
  - 任务详情页已添加 "Open in Notion" 按钮。
- [x] **Story O2 · Pending 任务补写至 Notion**
  - 实现了 `SyncPendingTasksForUser`，绑定群组数据库时自动触发回溯同步。
- [x] **Story S3/N2 · Notion Update Sync**
  - `UpdatePage` implemented. TG Status/Title updates sync to Notion.
- [x] **Notion Deletion Sync & Retry**
  - Support Notion `Archived` sync -> Local Soft Delete.
- [x] **Notion Deletion Sync & Retry**
  - Support Notion `Archived` sync -> Local Soft Delete.
  - Implemented Retry (3x, exp backoff) for Notion API clients.
- [x] **Bot Reply Logic Optimization**
  - Added "Bind Notion" CTA button for tasks created in unbound groups.
  - Added "Configure Notion" CTA for forwarded tasks in private chat.

---

### 下一步行动指南 (Next Steps)

1.  ✅ **Module 15 / Story S5: Notion Sync Content**
    - Refactored `NotionClient` to support Block children。
    - Updated `TaskCreator` to convert Description and Snapshots to Notion Blocks.
2.  ✅ **Story S8 & S9: Database Filter & Open in Notion**
    - S8: Implemented Database Filter Dropdown in HomePage.
    - S9: Added "Open in Notion" button in TaskDetail.

- ✅ 2025-12-10 [Story M1] 连接管理列表：完成群组列表页开发，支持查看绑定状态与解绑。
- ✅ 2025-12-10 [Story O2] 历史回溯：完成任务同步逻辑重构，实现绑定数据库时自动同步历史任务。
- 2025-12-10 | ✅ | M16 | Notion Poller Service implemented (Backend). Syncs creation/updates.
- 2025-12-10 | ✅ | S8 | Database Filter on Home Page (Frontend done, Poller integration done).
- 2025-12-10 | ✅ | S3/N2 | Notion Update Sync (Task Status/Title updates sync to Notion).
- 2025-12-10 | ✅ | S3/N2 | Notion Update Sync (Task Status/Title updates sync to Notion).
- 2025-12-10 | ✅ | Task | Notion Deletion Sync (Soft Delete on Archived) & API Retry Mechanism.
- 2025-12-10 | ✅ | Refinement | Bot Reply Logic Optimized (Added Bind CTA buttons).

## 📝 待确认事项 / Pending Decisions

- Story O2: Retroactive Sync (追溯同步) - 当前 Poller 仅同步最近 2 分钟的变更。是否需要全量同步？
- Poller 异常处理 (Rate Limit) - 当前简单记录日志，后续可能需要退避策略。

## 📅 Next Steps

1.  Verify Poller in staging environment (User action).
2.  Refinement: Frontend Unbind / Re-bind improvements if needed.

### 已完成里程碑 (Completed Milestones)

#### 2025-12-10

- ✅ **Docs · 验收清单扩充**：对照 PRD V2.1 补充了 Story 0/G1~G4/S2/S3/S4/S8/N1/N3/O1/O2/U1/M1 等缺失的验收场景，确保 QA 覆盖完整。
- ✅ **Story S4/S6 (上下文快照)**: 实现了 Telegram 消息上下文自动抓取、持久化及 Frontend Jump-to-Chat 功能。
- ✅ [Antigravity] 任务: 性能分析与优化完成。
  - **Context**: 用户反馈 iPhone 14 Pro Max 发烫卡顿。
  - **Action**:
    - **Global CSS**: 禁用移动端 `scan-line` 动画 (GPU 消耗大户)；移除移动端页面切换的 `blur` 滤镜。
    - **HomePage**: 替换 Header `backdrop-blur` 为纯色透明度；替换 List Item `clip-path` 为圆角边框 (减少合成层压力)；优化阴影。
    - **Round 2 (Deep Opt)**: 彻底隐藏移动端 `.grid-bg` (背景渐变)；禁用移动端骨架屏 Shimmer 动画；为 Touch 事件添加 `passive` 修饰符。
  - **Files**: `web/src/styles/main.css`, `web/src/pages/HomePage.vue`.
  - **Fix**: 修复 App.vue 中路由过渡动画方向反向的问题 (`page-slide-left` vs `page-slide-right` 逻辑互换)。
  - **Fix**: 修复 `TaskDetailPage` 底部评论框未固定的问题。
    - **原因**: 父级 `App.vue` 的过渡动画 wrapper 设置了 `will-change: transform`，导致子元素的 `position: fixed` 失效（相对于 wrapper 而非 viewport 定位），且 wrapper 随 body 滚动移出了屏幕。
    - **方案**: 重构详情页为 Flexbox 布局 (`h-full flex-col`)，Header/Footer 固定，中间 Main 区域内部滚动 (`overflow-y-auto`)。
  - **Refactor**: 重构 `TaskDetailPage` 顶部功能区为 **Grid Layout (宫格布局)**。
    - 使用 2 列 Grid 展示 Status, Due Date, Assignee, Source。
    - 相比旧版，大大节省了垂直空间，且卡片式设计点击热区更明确。
  - **Enhance**: 优化功能区排序与逻辑。
    - 排序: 状态/截止日期 -> 负责人/优先级 -> 创建人/来源。
    - 功能: 创建人点击跳转其 TG 会话；移除冗余的"查看完整记录"。
    - 字段: 后端已补齐 `Creator` 关联查询。
- ✅ **Module 18 (Native Assignment)**: 用于实现 Telegram 原生指派功能。
  - **Frontend**: `TaskDetailPage` 新增点击负责人触发 `switchInlineQuery("assign <TaskID>")`。
  - **Backend**: `TelegramService` 新增 `HandleInlineQuery` 响应任务卡片与 `HandleCallbackQuery` 处理指派认领逻辑。
  - **Core**: `TaskRepository` 与 `TaskService` 新增 `AssignTask` 方法。
- ✅ **Module 16 (Notion Poller)**: 实现了后端 Poller 服务，支持从 Notion 同步状态变更到 Telegram 任务 (Notion -> TG Sync)。解决并修复了所有编译错误与 Test Mocks。
- ✅ **Module 15 / Story S5 (内容同步)**: 实现了 Notion Block 映射。Task Description 转为 Paragraph，Chat Context 转为 Quote Block，并附带 Callout 格式的 Jump URL。
- ✅ **Story S8 (Database Filter)**: 确认前后端已支持 Database 筛选。
- ✅ **Story S9 (Open in Notion)**: 确认任务详情页"打开 Notion"按钮已实现。
- ✅ **Story O2 · Pending 任务补写至 Notion (Retroactive Sync)**
  - Implemented `SyncPendingTasks` in `TaskService`.
  - Trigger sync on Group Bind.
- ✅ **Story S3/N2 (Notion Update Sync)**: 实现了 TG -> Notion 的状态与标题更新同步 (UpdatePage)。

#### 2025-12-09

- ✅ **Story P1 (每日摘要)**: 集成 `robfig/cron`，实现每日 09:00 推送待办汇总。
- ✅ **Story S7 (转发创建)**: 实现了 Telegram 转发消息自动转换为个人任务 (Inbox)。
- ✅ **Story U1 (默认库)**: 实现了 Settings 页面选择默认 Notion Database，并与 S7 联动。

#### 2025-12-08

- ✅ **UI Rewrite (Vue 3)**: 完成所有页面（Home, Detail, Settings）的 UI 复刻与暗色模式适配。

#### Prior

- ✅ **Module 14: Notification System** (2025-05-24)
