## 2025-12-10 · Database-First Roadmap Refinement

### 当前状态

- **UI Migration**: `✅ 已完成` (Home, Detail, Settings, Onboarding 均已复刻 Prototype 样式)。
- **API Integration**: `🔄 进行中` (Task Detail 读取已完成)。
- **Focus**: 转向 **本地优先 (Database-First)** 策略，弱化 Notion 同步。

---

### ⏳ 稍后开发 (Backlog & Sync)

- [x] **Module 16 · Notion→TG 回流**
  - Poller Service 已实现 (Module 16)，支持 Notion 状态变更同步回 Telegram。
- [x] **Story S8 · 按 Database 筛选视图**
  - 首页已支持 Database 筛选器，API 已支持 `database_id` 过滤。
- [x] **Story S9 · 打开 Notion 深度编辑**
  - 任务详情页已添加 "Open in Notion" 按钮。
- [x] **Story O2 · Pending 任务补写至 Notion**
  - 实现了 `SyncPendingTasksForUser`，绑定群组数据库时自动触发回溯同步。
- [x] **Story S3/N2 · Notion Update Sync**
  - `UpdatePage` implemented. TG Status/Title updates sync to Notion.
- [x] **Notion Deletion Sync & Retry**
  - Support Notion `Archived` sync -> Local Soft Delete.
- [x] **Notion Deletion Sync & Retry**
  - Support Notion `Archived` sync -> Local Soft Delete.
  - Implemented Retry (3x, exp backoff) for Notion API clients.
- [x] **Bot Reply Logic Optimization**
  - Added "Bind Notion" CTA button for tasks created in unbound groups.
  - Added "Configure Notion" CTA for forwarded tasks in private chat.

---

### 下一步行动指南 (Next Steps)

1.  ✅ **Module 15 / Story S5: Notion Sync Content**
    - Refactored `NotionClient` to support Block children。
    - Updated `TaskCreator` to convert Description and Snapshots to Notion Blocks.
2.  ✅ **Story S8 & S9: Database Filter & Open in Notion**
    - S8: Implemented Database Filter Dropdown in HomePage.
    - S9: Added "Open in Notion" button in TaskDetail.

- ✅ 2025-12-10 [Story M1] 连接管理列表：完成群组列表页开发，支持查看绑定状态与解绑。
- ✅ 2025-12-10 [Story O2] 历史回溯：完成任务同步逻辑重构，实现绑定数据库时自动同步历史任务。
- 2025-12-10 | ✅ | M16 | Notion Poller Service implemented (Backend). Syncs creation/updates.
- 2025-12-10 | ✅ | S8 | Database Filter on Home Page (Frontend done, Poller integration done).
- 2025-12-10 | ✅ | S3/N2 | Notion Update Sync (Task Status/Title updates sync to Notion).
- 2025-12-10 | ✅ | S3/N2 | Notion Update Sync (Task Status/Title updates sync to Notion).
- 2025-12-10 | ✅ | Task | Notion Deletion Sync (Soft Delete on Archived) & API Retry Mechanism.
- 2025-12-10 | ✅ | Refinement | Bot Reply Logic Optimized (Added Bind CTA buttons).

## 📝 待确认事项 / Pending Decisions

- Story O2: Retroactive Sync (追溯同步) - 当前 Poller 仅同步最近 2 分钟的变更。是否需要全量同步？
- Poller 异常处理 (Rate Limit) - 当前简单记录日志，后续可能需要退避策略。

## 📅 Next Steps

1.  Verify Poller in staging environment (User action).
2.  Refinement: Frontend Unbind / Re-bind improvements if needed.

### 已完成里程碑 (Completed Milestones)

#### 2025-12-10

- ✅ **Docs · 验收清单扩充**：对照 PRD V2.1 补充了 Story 0/G1~G4/S2/S3/S4/S8/N1/N3/O1/O2/U1/M1 等缺失的验收场景，确保 QA 覆盖完整。
- ✅ **Story S4/S6 (上下文快照)**: 实现了 Telegram 消息上下文自动抓取、持久化及 Frontend Jump-to-Chat 功能。
- ✅ **Module 16 (Notion Poller)**: 实现了后端 Poller 服务，支持从 Notion 同步状态变更到 Telegram 任务 (Notion -> TG Sync)。解决并修复了所有编译错误与 Test Mocks。
- ✅ **Module 15 / Story S5 (内容同步)**: 实现了 Notion Block 映射。Task Description 转为 Paragraph，Chat Context 转为 Quote Block，并附带 Callout 格式的 Jump URL。
- ✅ **Story S8 (Database Filter)**: 确认前后端已支持 Database 筛选。
- ✅ **Story S9 (Open in Notion)**: 确认任务详情页"打开 Notion"按钮已实现。
- ✅ **Story O2 · Pending 任务补写至 Notion (Retroactive Sync)**
  - Implemented `SyncPendingTasks` in `TaskService`.
  - Trigger sync on Group Bind.
- ✅ **Story S3/N2 (Notion Update Sync)**: 实现了 TG -> Notion 的状态与标题更新同步 (UpdatePage)。

#### 2025-12-09

- ✅ **Story P1 (每日摘要)**: 集成 `robfig/cron`，实现每日 09:00 推送待办汇总。
- ✅ **Story S7 (转发创建)**: 实现了 Telegram 转发消息自动转换为个人任务 (Inbox)。
- ✅ **Story U1 (默认库)**: 实现了 Settings 页面选择默认 Notion Database，并与 S7 联动。

#### 2025-12-08

- ✅ **UI Rewrite (Vue 3)**: 完成所有页面（Home, Detail, Settings）的 UI 复刻与暗色模式适配。

#### Prior

- ✅ **Module 14: Notification System** (2025-05-24)
