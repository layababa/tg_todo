## 2025-11-24 · Backend-First Sprint

### 核心策略
- 沿用 `docs/server/backend-development-plan.md` 的 16 步，逐模块完成服务端 + API，再迁移 `prototype/` 对应页面到前端工程。
- 当前阶段聚焦 **后端基础设施 → Onboarding/API 契约**；前端 `web/src` 暂不恢复，仅保留 Prototype 参考。
- 每完成一个模块：更新本日志、同步 `docs/document-map.md`、整理下一页面的前端迁移 checklist。

---

### 当前聚焦模块
1. **基础设施 & 健康检查**（进行中）  
   - 目标：`cmd/api`/`cmd/bot` 启动体、config、middleware、`/healthz`，让现有 Go 测试转绿，Dockerfile 可用。
2. **身份 & Onboarding API**（排队）  
   - 目标：实现 `/auth/status`、`/auth/notion/url`、`/auth/notion/callback`，完成 Telegram init data 校验、用户建档、Notion token 管理。

### 后续模块排期
1. Telegram 更新接入 & 去重（模块 3）
2. 任务创建 / 上下文抓取（模块 4）
3. Deep Link / Start Param 路由（模块 5）
4. Tasks 列表 & 详情 API（模块 9，依赖任务模型）

> 完成每个模块后：更新本日志、补 `docs/document-map.md`、整理对应 Prototype 页面迁移 checklist。

---

### 模块任务板（按优先级 · 详细拆解）

#### 1) 基础设施 & 健康检查（已完成）
- ✅ `cmd/api` 启动程序：解析 config、初始化 logger、注册 Gin 中间件、暴露 `/healthz`。
- ✅ `internal/config`：实现 `Load()` 支持文件 + env fallback（满足 `config_test.go`）；补 `config/default.yml`（示例配置 + ENV 映射）。
- ✅ HTTP 中间件：
  - `middleware/request_id`：生成/透传 `X-Request-ID`，供日志/响应使用。
  - `middleware/recovery`：匹配测试期望，输出 `{success:false,error:{code:...},meta:{request_id}}`。
- ✅ Healthz handler：依赖 `healthz.Dependency` 接口注入 DB/Redis stub，返回版本、git hash、依赖状态。
- ⏳ `cmd/bot` 占位：先能加载 config+logger+DB，后续模块复用。
- ✅ `server/pkg/db/db.go` 已可复用；需在 `cmd/api` wiring 中接入 Postgres/Redis 配置（默认从 env, 支持 `DATABASE_DSN` 等）。
- ✅ 修正 go module name 为 `github.com/layababa/tg_todo/server`。
- ✅ Dockerfile 构建通过。

#### 2) 身份 & Onboarding API（排队中）
- ⏳ Telegram init data 校验：封装 `pkg/telegramauth`，支持 HMAC-SHA256 验证、签名过期判断。
- ⏳ User Repository：`users` + `user_notion_tokens` CRUD（参考 `db-schema.md`），同时引入迁移 SQL。
- ⏳ 接口实现（按 `docs/server/api-by-page.md`）：
  - `GET /auth/status`: 自动建档用户、返回 notion_connected、start_param 路由提示。
  - `GET /auth/notion/url`: 构造 OAuth URL（state、redirect_uri）。
  - `POST /auth/notion/callback`: 校验 state、加解密 token（AES-256-GCM）、写入 DB。
- ⏳ Notion 客户端：封装 `pkg/notion`（基于 `dstotijn/go-notion`），支持交换 token。
- ⏳ 单元测试：覆盖签名真伪、未授权用户、重复授权、token 过期刷新逻辑。

#### 3) Telegram 更新接入 & 去重（下一步）
- ⏳ 计划：Gin handler + `/webhook/telegram`，接收 `update`，接入 Redis `SETNX` 幂等、原始 update 落库。
- ⏳ Webhook 安全：校验 Bot Token、支持长轮询 fallback。
- ⏳ 命令路由：/start、/help、群成员状态事件写审计。

#### 4) 任务创建 & 上下文抓取
- ⏳ 计划：reply/forward/@Bot 解析，任务建模（`tasks`、`task_context_snapshots`、`task_assignees`）、Notion Page 写入。
- ⏳ Telegram API：抓取触发消息前 10 条上下文，生成 `chat_jump_url`。

#### 5) Deep Link / Start Param
- ⏳ 计划：`/bootstrap` 接口，解析 `start_param`，返回前端路由；生成 `task_{id}`、`group_{id}` deep link。

#### 6) Tasks 列表 & 详情 API
- ⏳ 列表：`GET /tasks` 视图过滤、分页、空状态。
- ⏳ 详情：`GET /tasks/{id}`，包含 context/description/comments；`PATCH/DELETE`、评论 CRUD。

> 模块 7-16（Notion OAuth/库管理/群组/指派/评论/通知/同步/Digest/设置/可观测）沿 backend plan 推进，待前述模块稳定后展开，每个模块提前梳理数据模型与依赖。

---

### 其他角色同步
- **产品**：PRD/FRD/Prototype 继续作为需求源，在后端模块完成时再补异常文案；暂不新增改动。
- **前端**：保持暂停；待 Onboarding + Tasks API 稳定后再恢复 `web/src`，并修复 `web/Dockerfile` 缺文件问题。
- **DevOps**：准备 `docs/deploy/`、CI 草稿、daisyUI 模板来源说明。
- **QA**：当前重点是 Go 单测与接口验证；前端 Vitest/Cypress 等待接口落地后恢复。

---

### 支撑工作 & 待办
- 📦 **数据库迁移**：为 `users`, `user_notion_tokens`, `tasks` 等表编写 `migrations/*.sql`；在 `cmd/api` 启动时执行 embed 迁移。
- 🛠 **DevOps**：
  - 🔄 `docs/deploy/`：记录 docker-compose、环境变量、daisyUI 模板来源、构建命令、端口、健康检查配置。
  - 🔄 `web/Dockerfile` 缺少 `daisyUI.template.css`：决定文件来源（版本库 or npm 脚本），补文件或调整 COPY。
  - ⏳ Build pipeline：准备 GitHub Actions/GitLab CI 草稿（lint/test/build/publish）。
- 📋 **文档**：完善 `docs/document-map.md` 对应条目、在 API 实现后补充示例响应。
- 🧪 **测试/QA**：
  - 🔄 让现有 Go 测试通过后，新增覆盖率门槛（≥60%）检查。
  - ⏳ 准备 Postman/HTTPie collection，用于验证 `/auth/*`、`/healthz`、后续 `/tasks` 接口。
  - ⏳ 规划 Telegram sandbox 脚本，验证 webhook/通知链路。
- 🎨 **前端待办**（暂缓执行）：
  - 找回/重建 `web/src`（Vue + Pinia + Router + DaisyUI）。
  - 为每个已完成 API 的页面编写数据适配层、Pinia store、组件。
  - 迁移 Prototype 的交互动效（pull-to-refresh、HUD、modal）。

---

### 48h 行动清单
1. **Infra 完成度 ≥90%**  
   - `cmd/api` 可运行，`/healthz` 返回版本、git hash、依赖列表。  
   - `make test` 全绿（config/middleware/healthz）。  
   - Dockerfile 可以构建并运行 `api` 容器，读取 env + 打印结构化日志。
2. **配置 & 依赖注入**  
   - 定义 `.env.example` / `config/default.yml`，覆盖 HTTP/DB/Redis/Telegram/Notion 配置。  
   - 在启动流程中初始化 Postgres/Redis 客户端并注入 healthz 依赖。
3. **Auth 模块预备**  
   - 确定 Telegram init data 校验方案，输出 `pkg/telegramauth` 接口。  
   - 起草 `users` / `user_notion_tokens` migration 与 repository 接口，为下一迭代的 `/auth/*` 实现做准备。

> 完成以上 48h 目标后，再拉通 Onboarding API、计划 Telegram webhook 模块，并视情况更新前端迁移节奏。
