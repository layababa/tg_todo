# 📈 完整部署工作流

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    你的开发工作流                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1️⃣ 本地开发                                                      │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ git checkout -b feature/new-feature                 │       │
│  │ npm run dev                                          │       │
│  │ (编写代码，测试功能)                                    │       │
│  │ npm run build  (确保构建通过)                         │       │
│  │ git add . && git commit -m "feat: ..."               │       │
│  └──────────────────────────────────────────────────────┘       │
│                        ↓                                         │
│  2️⃣ 推送到 GitHub                                                │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ git push origin feature/new-feature                 │       │
│  └──────────────────────────────────────────────────────┘       │
│                        ↓                                         │
│  3️⃣ GitHub 自动触发 Vercel                                       │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ ✓ Push webhook 触发                                  │       │
│  │ ✓ Vercel 接收通知                                    │       │
│  └──────────────────────────────────────────────────────┘       │
│                        ↓                                         │
│  4️⃣ Vercel 自动构建 (Preview)                                    │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ ✓ npm install                                        │       │
│  │ ✓ npm run build                                      │       │
│  │ ✓ 生成 dist 产物                                      │       │
│  │ ✓ 部署到 preview URL                                 │       │
│  └──────────────────────────────────────────────────────┘       │
│                        ↓                                         │
│  5️⃣ PR 关联预览链接                                               │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ https://feature-new.tg-todo.vercel.app              │       │
│  │ (自动在 PR 中显示)                                    │       │
│  └──────────────────────────────────────────────────────┘       │
│                        ↓                                         │
│  6️⃣ Code Review & Merge                                          │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ git checkout main                                    │       │
│  │ git merge feature/new-feature                        │       │
│  │ git push origin main                                 │       │
│  └──────────────────────────────────────────────────────┘       │
│                        ↓                                         │
│  7️⃣ Vercel 自动部署到生产环境 ✅                                 │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ ✓ npm install                                        │       │
│  │ ✓ npm run build                                      │       │
│  │ ✓ 部署到 production                                  │       │
│  │ ✓ https://tg-todo.vercel.app 更新                   │       │
│  │ ✓ DNS 自动更新                                       │       │
│  │ ✓ SSL 证书自动续期                                   │       │
│  └──────────────────────────────────────────────────────┘       │
│                        ↓                                         │
│  8️⃣ 用户看到最新版本 🎉                                          │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ https://tg-todo.vercel.app                          │       │
│  │ (自动刷新，无需任何人工操作)                             │       │
│  └──────────────────────────────────────────────────────┘       │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 时间轴

```
      你本地              GitHub              Vercel              用户
        │                  │                   │                   │
        │ git push         │                   │                   │
        ├─────────────────>│                   │                   │
        │                  │ Webhook 触发      │                   │
        │                  ├─────────────────>│                   │
        │                  │                   │ npm install       │
        │                  │                   │ npm run build    │
        │                  │ (等待 2-5 分钟)    │ 部署                │
        │                  │                   ├─────────────────>│
        │                  │                   │                   │ 刷新页面
        │                  │                   │                   │ 看到新版本 ✅
        │                  │                   │                   │
    0:00                1:00                5:00               5:30
```

---

## 部署环境

### 👁️ Preview（预览环境）
```
触发条件: 任何分支 push 或 PR 创建
URL 格式: https://[branch-name].tg-todo.vercel.app
保留时间: 取决于分支存在时间
自动删除: 分支删除后 24 小时
用途: 功能预览、Code Review
```

### 🚀 Production（生产环境）
```
触发条件: main 分支 push
URL 格式: https://tg-todo.vercel.app
缓存: Vercel CDN 全球加速
SSL: 自动 HTTPS
自动备份: 每个版本可回滚
用途: 真实用户访问
```

---

## 部署流程中的关键点

### ✅ 构建成功标准
```
✓ npm install 成功
✓ npm run build 无错误
✓ dist 文件夹生成
✓ 文件大小合理 (< 1GB)
✓ 没有 TypeScript 错误
```

### ⚠️ 构建失败原因
```
❌ 依赖版本冲突
❌ TypeScript 类型错误
❌ 环境变量缺失
❌ 构建脚本错误
❌ 导入路径错误
```

### 🔍 环境变量在构建中的作用
```
VITE_API_BASE_URL
├─ 构建时: 替换到 dist 代码中
├─ 前端访问: window.__VITE_API_BASE_URL__
└─ 用途: 告知前端 API 服务器地址
```

---

## 回滚流程

### 快速回滚到前一个版本
```
1. Vercel Dashboard → Deployments
2. 找到前一个成功的部署
3. 点击 ⋮ → "Promote to Production"
4. 确认 → 立即回滚完成 ✅

整个过程: 10 秒内完成
```

### 完整回滚示例
```
当前版本: v2.0 (有 Bug)
     ↓ 点击"回滚"
回滚到: v1.9 (稳定版本)
     ↓ 立即生效
用户看到: v1.9 版本

注: 数据库不受影响，可安全回滚
```

---

## 监控与告警

### 部署失败通知
```
Vercel 会自动：
✓ 发送邮件通知
✓ 显示失败原因
✓ 建议修复方案
✓ 提供构建日志链接

主分支失败时立即通知 (重要)
其他分支失败不通知 (可选)
```

### 性能监控
```
Vercel Analytics:
✓ 页面加载时间
✓ 首字节到达时间 (TTFB)
✓ Cumulative Layout Shift (CLS)
✓ 访问量统计

自动报告性能变化
```

---

## 最佳实践

### ✅ 推荐做法
```
1. 开发功能分支，保持 main 稳定
2. 每次 push 前本地 npm run build
3. 在 preview 环境验证功能
4. 只有通过测试才 merge 到 main
5. main 自动部署到生产环境
```

### ❌ 避免做法
```
1. 直接推送到 main 而不测试
2. 在 main 中频繁提交 WIP 代码
3. 忽视构建失败的邮件通知
4. 没有 .gitignore 推送大文件
5. 提交敏感信息 (API keys 等)
```

---

## 自动部署 vs 手动部署

### 自动部署（推荐）✅
```
优点:
✓ 无需手动操作
✓ 降低人工错误
✓ 快速反馈
✓ 持续集成 (CI/CD)
✓ 版本历史完整

缺点:
✗ 需要自动化测试
✗ 需要良好的代码质量
```

### 手动部署
```
优点:
✓ 完全控制何时部署
✓ 可以批量变更

缺点:
✗ 容易遗忘
✗ 人工错误风险高
✗ 更新延迟
✗ 无法追踪
```

---

## 故障排除

### 部署卡住（> 10 分钟）
```
1. 检查 Vercel Dashboard 日志
2. 查看 GitHub Actions 状态
3. 检查是否有大文件被推送
4. 清除 node_modules 并重新推送
```

### 功能在预览中工作但生产中不工作
```
原因常见: 环境变量不同
解决:
1. 检查 VITE_API_BASE_URL 设置
2. 确保 Preview 和 Production 环境变量一致
3. 浏览器清除缓存
4. 强制刷新 (Ctrl+Shift+R)
```

### CDN 缓存问题
```
问题: 更新了代码但看不到效果
原因: Vercel CDN 缓存了旧文件

解决方案:
1. Vercel Dashboard → Deployments
2. 点击最新部署
3. 找到 "Redeploy" 按钮
4. 点击 Redeploy → 清除缓存并重新部署
```

---

## 安全建议

### ✅ 环境变量最佳实践
```
✓ 从不提交 .env 文件
✓ 使用 .env.example 作为模板
✓ 在 Vercel Dashboard 中管理密钥
✓ 定期轮换 API 密钥
✓ Preview 和 Production 使用不同密钥
```

### ✅ 代码审查
```
✓ 所有改动必须通过 PR
✓ 至少一个人审查代码
✓ 自动化测试必须通过
✓ Vercel 预览部署成功
✓ 然后才能 merge 到 main
```

---

## 完整检查清单

部署前：
- [ ] `npm run build` 本地成功
- [ ] `npm run lint` 无错误
- [ ] `npm run test` 通过（如果有）
- [ ] `.env.example` 已更新
- [ ] `git status` 提交了所有文件

部署中：
- [ ] Vercel 构建成功
- [ ] Preview URL 功能正常
- [ ] 没有控制台错误
- [ ] API 连接正常

部署后：
- [ ] Production URL 可访问
- [ ] 功能完全可用
- [ ] 性能没有下降
- [ ] 移动设备也正常

---

**现在你已经掌握了完整的自动部署流程！** 🚀

