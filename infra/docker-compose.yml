services:
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: tg_todo
      POSTGRES_USER: tg_todo
      POSTGRES_PASSWORD: change-me
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  api:
    build:
      context: ../server
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ../server/.env
    environment:
      HTTP_ADDR: :8080
      DATABASE_DSN: postgres://tg_todo:change-me@db:5432/tg_todo?sslmode=disable
      REDIS_ADDR: redis:6379
      DB_MAX_OPEN_CONNS: 10
      DB_MAX_IDLE_CONNS: 5
      DB_CONN_MAX_LIFETIME: 1800
      TELEGRAM_API_URL: https://api.telegram.org
      SERVICE_API_TOKEN: ${SERVICE_API_TOKEN:-local-service-token}
    ports:
      - "8080:8080"
    depends_on:
      - db
      - redis

  # bot:
  #   build:
  #     context: ../server
  #     dockerfile: Dockerfile
  #   command: ["/app/bot"]
  #   restart: unless-stopped
  #   environment:
  #     TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
  #     TELEGRAM_API_URL: https://api.telegram.org
  #     SERVICE_API_TOKEN: ${SERVICE_API_TOKEN:-local-service-token}
  #     POSTGRES_URL: postgres://tg_todo:change-me@db:5432/tg_todo?sslmode=disable
  #     DB_MAX_OPEN_CONNS: 10
  #     DB_MAX_IDLE_CONNS: 5
  #     DB_CONN_MAX_LIFETIME: 1800
  #   depends_on:
  #     - db

  # Web服务已注释 - 开发时在本地手动运行 `cd web && pnpm dev`
  # web:
  #   build:
  #     context: ..
  #     dockerfile: web/Dockerfile
  #     args:
  #       VITE_API_BASE_URL: http://api:8080
  #   restart: unless-stopped
  #   ports:
  #     - "5173:80"
  #   depends_on:
  #     - api

volumes:
  postgres-data:
  redis-data:
