# 📄 Telegram To-Do Mini App 产品需求文档 (PRD V1.0 - 增强版)

## 一、产品概述

* **产品名称**：Telegram To-Do Mini App (暂定)
* **目标**：提供高效、无缝集成的 Telegram 待办管理工具，尤其擅长群组内的快速任务指派和共享协作。
* **核心交互**：Bot 负责**创建**，Mini App 负责**管理**和**查看**。
* **技术栈要求**：
    * **后端服务**：GoLang
    * **数据库**：PostgreSQL
    * **部署**：Docker
* **用户认证**：依赖 Telegram 内置的账号体系 (TG User ID)。

---

## 二、Mini App 页面结构与功能

Mini App 包含两个核心页面：**待办列表页**和**待办详情/编辑页**。

### 1. 待办列表页 (To-Do List View)

| 区域/元素 | 描述 | 交互细节 |
| :--- | :--- | :--- |
| **顶部 Tab/Segment** | 两个Tab：**未完成（Pending）** 和 **已完成（Completed）**。 | 用户点击切换列表视图。默认停留在“未完成” Tab。 |
| **列表排序** | 默认显示**创建时间倒序**（最新创建在最上方）。 | V1.0 暂不提供其他维度排序或筛选功能。 |
| **待办卡片 (Item)** | **主要元素**：待办标题（截断显示）、创建人头像/昵称（缓存）、创建时间。 | 1. **点击**卡片：跳转到**待办详情/编辑页**。 |
| **完成标记按钮** | 在“未完成” Tab 的每张卡片上显示一个**未选中**的复选框 (Checkbox)。 | **交互**：点击复选框即标记任务**完成**。立即更新当前列表，并将该任务移至“已完成” Tab。如果是共享任务，则触发**Bot通知**。 |
| **可见性** | 每个用户只能看到**与自己相关**的待办（即自己是创建人或指派人）。 | 基于用户 TG User ID 权限隔离。 |
| **列表空状态** | 当列表中无任务时显示的友好提示。 | 例如：“太棒了，目前没有未完成的任务！” |

### 2. 待办详情/编辑页 (Detail/Edit View)

用户从列表页点击任务卡片进入此页面，进行查看和编辑操作。

| 区域/元素 | 描述 | 交互细节 |
| :--- | :--- | :--- |
| **任务标题** | 待办的完整标题/内容。 | **交互**：允许用户**编辑**文本内容。保存时需调用后端 API 更新。 |
| **完成状态切换** | 一个明显的切换开关或大的复选框，显示当前状态。 | **交互**：用户可点击切换任务的完成状态（未完成 ↔︎ 已完成）。**权限**：创建人可自由切换，被指派人只能标记**完成**。 |
| **创建人信息** | 显示**缓存的**创建人头像和昵称。 | 仅供查看。 |
| **指派给谁** | 显示所有**被指派人**的昵称列表。 | V1.0 暂不允许在此页面修改指派人。 |
| **原始消息来源 (L)** | 一个按钮或链接，显示 “查看原始消息”。 | **交互**：点击后，跳转到该待办创建时的 **Telegram 原始消息位置** (Deep Link)。 |
| **操作按钮 (创建人权限)** | 仅当当前用户是该待办的**创建人**时显示。 | 1. **删除按钮**：点击后需二次确认，确认后调用 API 删除任务。 |

---

## 三、待办创建与 Bot 交互逻辑

Bot 负责侦听所有符合条件的入站消息，并根据逻辑将数据写入 PostgreSQL。

| 场景编号 | 您的功能描述 | 内容提取逻辑 | 指派人逻辑 |
| :--- | :--- | :--- | :--- |
| **1** | 将聊天记录**转发**给 Bot。 | 转发消息的**全部内容**（文本或非文本的 Caption/标记）。 | 仅**转发人**（即创建人）。 |
| **2** | **引用**消息并 `@bot`（单人）。 | 被引用的原始消息**全部内容**。 | 仅**发送引用消息的用户**（即创建人）。 |
| **3** | **引用**消息并 `@bot` 且 `@其他人`（多人）。 | 被引用的原始消息**全部内容**。 | **回复消息的用户** + **回复消息中被 `@提及` 的用户**。 |
| **4** | 在**群里** `@bot` 给 Bot 发消息（单人）。 | 该消息的**全部内容**。 | 仅**发送消息的用户**（即创建人）。 |
| **5** | 在**群里** `@bot` 并 `@其他人`（多人）。 | 该消息的**全部内容**。 | **发送消息的用户** + **消息中被 `@提及` 的用户**。 |

### 内容处理逻辑细节

* **非文本消息 (Q)**：如果转发或引用的消息是图片、文件等非文本，如果有**配文 (Caption)** 则作为待办标题；详情需标记内容类型并依赖原始消息链接查看。
* **群组权限 (R)**：Bot 不需要在群组中拥有管理员权限。所有群员都拥有平等的创建任务权限。

---

## 四、关键逻辑与状态管理

### 1. 多人协作与完成状态
* **共享完成 (D)**：一个指派给多人的待办，状态在数据库中是**共享**的。**任意一个**被指派人标记完成，该待办即视为对所有指派人**已完成**。
* **Bot 通知 (S)**：任务被标记完成时，Bot 必须立即向**创建人**和**所有其他被指派人**发送 **Telegram 私聊通知**，告知完成状态和完成人。

### 2. 权限与编辑 (E)
* **创建人权限**：创建人拥有最高权限，包括**删除**、**编辑标题**和**撤销/更改**完成状态。
* **指派人权限**：被指派人只能对任务执行**标记完成/未完成**的操作。

---

## 服务端技术栈
1. 数据库必须要用PostgreSQL
2. 后端必须要用GoLang
3. 部署必须要用Docker
4. 前端部署 需要部署在vercel.com， 因为miniapp 有https 强制要求
